distcov_fast <- function(X, Y) {
    n <- length(X)
    temp <- 1:n

    vX <- Sort(X)
    IX0 <- sort_index(X)
    IX[IX0] <- temp

    vY <- Sort(Y)
    IY0 <- sort_index(Y)
    IY[IY0] <- temp


    sX <- cumsum(vX)
    sY <- cumsum(vY)
    alphaX <- IX - 1
    alphaY <- IY - 1
    betaX <- sX[IX] - vX[IX]
    betaY <- sY[IY] - vY[IY]
    Xdot <- sum(X)
    Ydot <- sum(Y)

    aidot <- Xdot + (2 * alphaX - n) * X - 2 * betaX
    bidot <- Ydot + (2 * alphaY - n) * Y - 2 * betaY
    Sab <- sum(aidot * bidot)

    adotdot <- 2 * sum(alphaX * X) - 2 * sum(betaX)
    bdotdot <- 2 * sum(alphaY * Y) - 2 * sum(betaY)

    gamma_1  <- PartialSum2D(X, Y, rep(1, n))
    gamma_X  <- PartialSum2D(X, Y, X)
    gamma_Y  <- PartialSum2D(X, Y, Y)
    gamma_XY <- PartialSum2D(X, Y, X * Y)

    aijbij <- sum(X * Y * gamma_1 + gamma_XY - X * gamma_Y - Y * gamma_X)
    dCov <- aijbij / n / (n - 3) - 2 * Sab / n / (n - 2) / (n - 3) + adotdot * bdotdot / n / (n - 1) / (n - 2) / (n - 3)
}
